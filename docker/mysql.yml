version: '3.8'
services:
  master:
    image: mysql:8.0.40
    container_name: mysql-master
    command: >
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=row
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --default-authentication-plugin=mysql_native_password
      --bind-address=0.0.0.0
      --sync-binlog=100
      --innodb-flush-log-at-trx-commit=2
      --binlog-transaction-dependency-tracking=WRITESET
      --transaction-write-set-extraction=XXHASH64
      --binlog-group-commit-sync-delay=1000
      --binlog-group-commit-sync-no-delay-count=10
      --binlog-cache-size=1M
      --innodb-buffer-pool-size=256M
      --innodb-log-buffer-size=32M
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_MASTER_PASSWORD:-masterpassword}
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: ecommerce_dev
    networks:
      - mysql-cluster
    ports:
      - "3306:3306"
    volumes:
      - master-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_MASTER_PASSWORD:-masterpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  slave1:
    image: mysql:8.0.40
    container_name: mysql-slave1
    command: >
      --server-id=2
      --log-bin=mysql-bin
      --binlog-format=row
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --default-authentication-plugin=mysql_native_password
      --skip-slave-start=1
      --read-only=ON
      --bind-address=0.0.0.0
      --replica-parallel-workers=8
      --replica-parallel-type=LOGICAL_CLOCK
      --replica-preserve-commit-order=ON
      --sync-relay-log=1000
      --sync-relay-log-info=1000
      --innodb-flush-log-at-trx-commit=2
      --sync-binlog=100
      --innodb-buffer-pool-size=256M
      --innodb-log-buffer-size=32M
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_SLAVE1_PASSWORD:-slave1password}
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: ecommerce_dev
    networks:
      - mysql-cluster
    depends_on:
      master:
        condition: service_healthy
    ports:
      - "3307:3306"
    volumes:
      - slave1-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_SLAVE1_PASSWORD:-slave1password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  slave2:
    image: mysql:8.0.40
    container_name: mysql-slave2
    command: >
      --server-id=3
      --log-bin=mysql-bin
      --binlog-format=row
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
      --default-authentication-plugin=mysql_native_password
      --skip-slave-start=1
      --read-only=ON
      --bind-address=0.0.0.0
      --replica-parallel-workers=8
      --replica-parallel-type=LOGICAL_CLOCK
      --replica-preserve-commit-order=ON
      --sync-relay-log=1000
      --sync-relay-log-info=1000
      --innodb-flush-log-at-trx-commit=2
      --sync-binlog=100
      --innodb-buffer-pool-size=256M
      --innodb-log-buffer-size=32M
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_SLAVE2_PASSWORD:-slave2password}
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: ecommerce_dev
    networks:
      - mysql-cluster
    depends_on:
      master:
        condition: service_healthy
    ports:
      - "3308:3306"
    volumes:
      - slave2-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_SLAVE2_PASSWORD:-slave2password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mysql-init:
    image: mysql:8.0.40
    container_name: mysql-init
    networks:
      - mysql-cluster
    volumes:
      - ./scripts:/scripts
    environment:
      MYSQL_MASTER_PASSWORD: ${MYSQL_MASTER_PASSWORD:-masterpassword}
      MYSQL_SLAVE1_PASSWORD: ${MYSQL_SLAVE1_PASSWORD:-slave1password}
      MYSQL_SLAVE2_PASSWORD: ${MYSQL_SLAVE2_PASSWORD:-slave2password}
      MYSQL_REPL_USER: ${MYSQL_REPL_USER:-repl_user}
      MYSQL_REPL_PASSWORD: ${MYSQL_REPL_PASSWORD:-replica_ecommerce}
    command: ["/bin/bash", "/scripts/init-mysql.sh"]
    depends_on:
      master:
        condition: service_healthy
      slave1:
        condition: service_healthy
      slave2:
        condition: service_healthy
    restart: no

networks:
  mysql-cluster:
    driver: bridge

volumes:
  master-data:
    driver: local
  slave1-data:
    driver: local
  slave2-data:
    driver: local